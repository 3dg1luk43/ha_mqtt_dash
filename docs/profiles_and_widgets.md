# Profiles and widgets

Profiles define the device UI and are stored in Home Assistant’s Store. Profiles are per device (keyed by `device_id`); there is no separate shared profile library in the current flow.

Device settings and persistence
- Retained device settings include brightness (0..1), keep_awake, orientation (auto|portrait|landscape). The app applies them on load and reconnect.
- The HA Store is the canonical source for profiles and per‑device settings; options mirror Store for editing.

Developer overlay
- Set `devOverlay` to true under `ui.grid` to draw a faint grid and x,y labels (x=column, y=row). Overlay is pass‑through and does not block touches.

Profile guidelines
- Edit the profile for a specific device in the integration Options (“Edit device profile”). The effective profile key equals the device_id.
- If a pasted profile is wrapped like `{ "<name>": { ... } }`, the integration unwraps automatically.
- Do not include MQTT topics in profiles. The integration injects `state_topic`, optional `attr_topic` (e.g., brightness for lights), and `command_topic`.
- Layout shorthands supported: `x|col`, `y|row`, `w|colspan`, `h|rowspan`.

Grid
- `columns`: number of columns
- `widget_dimensions`: [width, height] of a single cell in points
- `widget_margins`: [marginX, marginY] in points
- `widget_size`: [cellW, cellH] default widget span
- `devOverlay`: boolean to show grid indices overlay (authoring aid)

Widgets (accepted input fields before normalization):
- `id`: string — optional; autogenerated if missing
- `type`: string — one of: `light`, `switch`, `scene`, `sensor`, `value`, `person`, `button`, `label`, `clock`, `weather`, `spacer`
- `entity_id` | `entity` | `eid`: string — entity id (not required for `label`/`clock`)
- `label` | `lbl`: string — display label; defaults to `entity_id`
- Position and span (aliases accepted):
    - `x` | `col`: number (default 0)
    - `y` | `row`: number (default 0)
    - `w` | `colspan`: number (min 1; default 1)
    - `h` | `rowspan`: number (min 1; default 1)
- `unit`: string — for `sensor`/`value`
- `format`: object — formatting options (whitelisted keys only; see below)
- `protected`: true/false — for actionable widgets (light/switch/scene/button) to require swipe-to-confirm
- `text`: string — only for `label` (no entity)
- `time_pattern`: string — only for `clock` (no entity)
- Weather-specific:
    - `attrs`: array of strings — attribute keys to display (e.g., `temperature`, `humidity`, `wind_speed`)
    - `attr_units`: object — map of key→unit string (optional; app has defaults)

Widget normalization (final form):
- All widgets include:
    - `id`, `type`, `entity_id`, `label`, `x`, `y`, `w`, `h`
    - `unit`: if provided
    - `format`: only keys in { `align`, `vAlign`, `textSize`, `textColor`, `bgColor`, `onTextColor`, `offTextColor`, `onBgColor`, `offBgColor`, `wrap`, `maxLines` }
    - `protected`: if provided and boolean
- Light extras:
    - `attr_topic`: `mqttdash/statestream/light/<object>/attributes/brightness`
- Label extras:
    - `text`: provided text
- Clock extras:
    - `time_pattern`: if provided
- Weather extras:
    - `attr_base`: `mqttdash/statestream/weather/<object>/attributes`
    - `attrs`: list of keys (if provided)
    - `attr_units`: map of key→unit (if provided)

Types:
- light: On/off; optional brightness slider when attributes are mirrored. Supports align, vAlign, textSize, on/off colors, and protected. `attr_topic` for brightness is auto‑injected.
- switch: On/off as a full‑tile stateful button (no tiny UISwitch). Supports align, vAlign, textSize, on/off colors, and protected.
- scene: Stateless trigger; can reflect active state by color if mirrored. Supports align, vAlign, textSize, on/off colors, and protected.
- sensor/value: Shows value and optional unit (unit renders at 0.5x). Supports align, vAlign, textSize, textColor, bgColor, wrap/maxLines.
- person: Same as sensor.
- button: Stateless press; supports align, vAlign, textSize, textColor, bgColor, and protected.
- label: Static text only; supports align, vAlign, textSize, textColor, wrap/maxLines; tile background uses bgColor.
- clock: Local device time; no entity required. Optional `time_pattern` like `HH:MM:SS`, `HH:MM`, or custom tokens.
- weather: For `weather.*` entities. Provide `attrs` (list of attribute keys to show). Optional `attr_units` maps key→unit string. Integration supplies `attr_base` for MQTT subscriptions. The client has sensible default units for common keys (e.g., humidity %, pressure hPa).

Formatting keys (`format`):
- `align`: `left` | `center` | `right`
- `vAlign`: `top` | `middle` | `bottom`
- `textSize`: number (points)
- `textColor`: hex string
- `bgColor`: hex string
- `onTextColor`, `offTextColor`: hex strings
- `onBgColor`, `offBgColor`: hex strings
- `wrap`: true/false — enable multi-line wrapping
- `maxLines`: number — maximum lines to display (when `wrap` true)

Widget configuration examples
Light with brightness and colors:
```json
{
    "id": "w1",
    "type": "light",
    "entity_id": "light.living_room",
    "label": "Living Room",
    "x": 0,
    "y": 0,
    "w": 1,
    "h": 1,
    "format": {
        "align": "left",
        "vAlign": "bottom",
        "textSize": 20,
        "onBgColor": "#145214",
        "offBgColor": "#222",
        "onTextColor": "#fff",
        "offTextColor": "#ddd"
    }
}
```

Sensor with unit and alignment:
```json
{
    "id": "t1",
    "type": "sensor",
    "entity_id": "sensor.outdoor_temp",
    "unit": "°C",
    "label": "Outside",
    "x": 1,
    "y": 0,
    "w": 1,
    "h": 1,
    "format": {
        "align": "right",
        "vAlign": "top",
        "textSize": 24,
        "textColor": "#8ad"
    }
}
```

Button and scene:
```json
{
    "id": "b1",
    "type": "button",
    "label": "Doorbell",
    "x": 0,
    "y": 1,
    "w": 1,
    "h": 1,
    "format": {
        "bgColor": "#222",
        "textColor": "#fff"
    }
}
{
    "id": "s1",
    "type": "scene",
    "entity_id": "scene.movie_night",
    "label": "Movie Night",
    "x": 1,
    "y": 1,
    "w": 1,
    "h": 1,
    "format": {
        "onBgColor": "#334",
        "offBgColor": "#111"
    }
}
```

Protected switch (full‑tile) with colors:
```json
{
    "id": "sw1",
    "type": "switch",
    "entity_id": "switch.kettle",
    "label": "Kettle",
    "protected": true,
    "x": 2,
    "y": 1,
    "w": 1,
    "h": 1,
    "format": {
        "onBgColor": "#2E7D32",
        "offBgColor": "#263238",
        "onTextColor": "#FFFFFF",
        "offTextColor": "#B0BEC5"
    }
}
```

Clock widget:
```json
{
    "id": "clk1",
    "type": "clock",
    "label": "Time",
    "time_pattern": "HH:MM:SS",
    "x": 3, "y": 0, "w": 1, "h": 1
}
```

Weather widget (attributes with units):
```json
{
    "id": "wx1",
    "type": "weather",
    "entity_id": "weather.home",
    "label": "Weather",
    "attrs": ["temperature", "humidity", "wind_speed"],
    "attr_units": { "temperature": "°C", "humidity": "%", "wind_speed": "km/h" },
    "x": 4, "y": 0, "w": 2, "h": 1
}
```